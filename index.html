<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Planificador Semanal</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f6f9; }
    nav { display:flex; justify-content:space-between; align-items:center; background:#333; color:white; padding:10px 20px; }
    nav ul { list-style:none; display:flex; margin:0; padding:0; }
    nav ul li { margin:0 10px; }
    nav ul li a, nav ul li button { color:white; text-decoration:none; background:none; border:none; cursor:pointer; font-size:16px; }
    .container { padding:20px; }
    table { width:100%; border-collapse:collapse; text-align:center; }
    th, td { border:1px solid #ddd; padding:10px; vertical-align:top; }
    th { background:#4CAF50; color:white; }
    .activity { background:white; padding:8px; margin:5px 0; border-radius:6px; cursor:pointer; border:1px solid #ccc; }
    .activity.done { background:#d4edda; border:1px solid #28a745; }
    .controls { margin:15px 0; text-align:center; }
    .controls button { padding:8px 15px; margin:0 5px; cursor:pointer; border:none; border-radius:6px; background:#0984e3; color:white; font-weight:bold; }
    #logoutBtn { background:#e74c3c; padding:6px 12px; border:none; border-radius:5px; cursor:pointer; color:white; }
  </style>
</head>
<body>
  <nav>
    <div class="logo">üìÖ Mi Agenda</div>
    <ul id="menu"></ul>

    <div class="logo"><a style="color: white;" href="login.html">Iniciar secci√≥n</a></div>
  </nav>

  <div class="container">
    <h2 id="welcomeMsg"></h2>

    <div class="controls">
      <button onclick="prevWeek()">‚èÆ Semana anterior</button>
      <span id="weekLabel"></span>
      <button onclick="nextWeek()">‚è≠ Semana siguiente</button>
    </div>

    <table>
      <tr id="daysHeader"></tr>
      <tr id="daysContent"></tr>
    </table>
    <button id="newActivityBtn">‚ûï Nueva Actividad</button>
  </div>

  <!-- Modal -->
  <div class="modal" id="activityModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center;">
    <div class="modal-content" style="background:white; padding:20px; border-radius:10px; width:350px;">
      <h3 id="modalTitle">Nueva Actividad</h3>
      <input type="text" id="activityText" placeholder="Descripci√≥n de la actividad">
      <select id="daySelect"></select>
      <select id="assignedUser"></select>
      <button onclick="saveActivity()">Guardar</button>
      <button onclick="closeModal()">Cancelar</button>
    </div>
  </div>

  <script>
    let activities = JSON.parse(localStorage.getItem("activities")) || [];
    let editingIndex = null;
    const users = JSON.parse(localStorage.getItem("users")) || [];
    const currentUser = JSON.parse(localStorage.getItem("currentUser"));

    // Fecha base = lunes actual
    let currentMonday = getMonday(new Date());

    function getMonday(d) {
      d = new Date(d);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); 
      return new Date(d.setDate(diff));
    }

    function formatDate(date) {
      return date.toISOString().split("T")[0];
    }

    function renderCalendar() {
      const days = ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"];
      const headerRow = document.getElementById("daysHeader");
      const contentRow = document.getElementById("daysContent");
      headerRow.innerHTML = "";
      contentRow.innerHTML = "";

      let weekStart = new Date(currentMonday);
      let weekEnd = new Date(currentMonday);
      weekEnd.setDate(weekStart.getDate()+6);

      document.getElementById("weekLabel").textContent =
        `Semana: ${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;

      for(let i=0; i<7; i++){
        const day = new Date(currentMonday);
        day.setDate(currentMonday.getDate()+i);

        // Encabezado con nombre + fecha
        const th = document.createElement("th");
        th.textContent = days[i] + " " + day.toLocaleDateString();
        headerRow.appendChild(th);

        // Celda actividades
        const td = document.createElement("td");
        td.id = formatDate(day);
        contentRow.appendChild(td);
      }

      renderActivities();
    }

    function renderUsers() {
      const select = document.getElementById("assignedUser");
      select.innerHTML = "";
      users.forEach(u => {
        const option = document.createElement("option");
        option.value = u.username;
        option.textContent = u.username + " ("+u.role+")";
        select.appendChild(option);
      });
    }

    function renderActivities() {
      document.querySelectorAll("#daysContent td").forEach(td => td.innerHTML="");

      activities.forEach((a, i) => {
        const div = document.createElement("div");
        div.className = "activity " + (a.status==="Finalizada" ? "done" : "");
        div.textContent = a.text + " [" + a.assigned + "] - Estado: " + a.status;
        div.onclick = () => editActivity(i);

        const dayCell = document.getElementById(a.date);
        if(dayCell) dayCell.appendChild(div);
      });

      localStorage.setItem("activities", JSON.stringify(activities));
    }

    function openModal(edit=false, index=null) {
      document.getElementById("activityModal").style.display = "flex";
      const daySelect = document.getElementById("daySelect");
      daySelect.innerHTML = "";

      for(let i=0; i<7; i++){
        const d = new Date(currentMonday);
        d.setDate(currentMonday.getDate()+i);
        const opt = document.createElement("option");
        opt.value = formatDate(d);
        opt.textContent = d.toLocaleDateString();
        daySelect.appendChild(opt);
      }

      if (edit) {
        editingIndex = index;
        const act = activities[index];
        document.getElementById("activityText").value = act.text;
        document.getElementById("daySelect").value = act.date;
        document.getElementById("assignedUser").value = act.assigned;
        document.getElementById("modalTitle").textContent = "Editar Actividad";
      } else {
        editingIndex = null;
        document.getElementById("activityText").value = "";
        document.getElementById("modalTitle").textContent = "Nueva Actividad";
      }
    }

    function closeModal() {
      document.getElementById("activityModal").style.display = "none";
    }

    function saveActivity() {
      const text = document.getElementById("activityText").value;
      const date = document.getElementById("daySelect").value;
      const assigned = document.getElementById("assignedUser").value;

      if (!text) { alert("La actividad no puede estar vac√≠a."); return; }

      if (editingIndex !== null) {
        activities[editingIndex].text=text;
        activities[editingIndex].date=date;
        activities[editingIndex].assigned=assigned;
      } else {
        activities.push({ text, date, assigned, status:"Pendiente" });
      }
      renderActivities();
      closeModal();
    }

    function editActivity(i) {
      const act = activities[i];
      if(currentUser.role==="admin"){
        const action = prompt("Opciones: editar / eliminar / estado", "editar");
        if(action==="editar"){ openModal(true, i); }
        else if(action==="eliminar"){ if(confirm("¬øEliminar actividad?")){ activities.splice(i,1); renderActivities(); } }
        else if(action==="estado"){
          const newState = prompt("Estado: Pendiente / Realizando / Finalizada", act.status);
          if(newState){ activities[i].status=newState; renderActivities(); }
        }
      } else if(currentUser.username===act.assigned){
        if(confirm("¬øQuieres marcar esta actividad como Finalizada?")){
          activities[i].status="Finalizada";
          renderActivities();
        }
      } else {
        alert("No tienes permiso para modificar esta actividad.");
      }
    }

    function logout() {
      localStorage.removeItem("currentUser");
      window.location.href = "login.html";
    }

    function nextWeek() {
      currentMonday.setDate(currentMonday.getDate()+7);
      renderCalendar();
    }

    function prevWeek() {
      currentMonday.setDate(currentMonday.getDate()-7);
      renderCalendar();
    }

    // Inicializaci√≥n
    document.getElementById("welcomeMsg").textContent =
      "Bienvenido " + currentUser.username + " (" + currentUser.role + ")";
    if(currentUser.role==="admin"){
      document.getElementById("menu").innerHTML = `
        <li><a href="index.html">Planificador</a></li>
        <li><a href="personal.html">Personal</a></li>
        <li><button id="logoutBtn">Cerrar Sesi√≥n</button></li>`;
    } else {
      document.getElementById("menu").innerHTML = `
        <li><a href="index.html">Planificador</a></li>
        <li><button id="logoutBtn">Cerrar Sesi√≥n</button></li>`;
      document.getElementById("newActivityBtn").style.display="none";
    }

    document.getElementById("logoutBtn").onclick = logout;
    if(document.getElementById("newActivityBtn")){
      document.getElementById("newActivityBtn").onclick=()=>openModal();
    }

    renderUsers();
    renderCalendar();
  </script>
</body>
</html>
